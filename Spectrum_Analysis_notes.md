# 频谱分析与归一化笔记

## 1. 功率谱 (Power Spectrum) vs 功率谱密度 (Power Spectral Density, PSD)

### 功率谱 (Power Spectrum)
- **定义**：描述信号在不同频率上的功率分布，总功率分布在各频率 bin 中。
- **单位**：通常是功率单位（如 V²）或幅值平方。
- **特点**：直接反映每个频率 bin 的能量，与 bin 宽度有关（FFT 长度不同会影响数值）。
- **应用场景**：关注总功率和各频率成分相对贡献，不追求频率分辨率一致性时。

### 功率谱密度 (Power Spectral Density, PSD)
- **定义**：单位带宽上的功率分布，即功率除以频率分辨率 Δf，得到“每 Hz 上的功率”。
- **单位**：V²/Hz（或功率单位/Hz）。
- **特点**：与 FFT 长度无关，可直接比较不同分辨率下的谱值。
- **应用场景**：需要物理意义的功率密度，或不同采样率、FFT 长度结果可比时。

---

## 2. 单位带宽归一化

### 频率分辨率的概念
* **Fs** = 采样率（Hz），比如 25 MHz 表示每秒采 2500 万个点。
* **nfft** = 做 FFT 时的点数。
* FFT 结果其实是把信号的频率范围 **0 \~ Fs** 切成若干个小格子（频率 bin）。

### Δf 是什么
* Δf 就是 **每个频率格子的宽度**（单位 Hz）。
* 算法公式就是：

```
\Delta f = \frac{\text{采样率 Fs}}{\text{FFT点数 nfft}}
```

**例子：**

* Fs = 25 MHz，nfft = 512

```
\Delta f = \frac{25 \times 10^6}{512} \approx 48.828 \ \text{kHz}
```
意思是：FFT 结果中相邻两个频率点之间间隔 48.8 kHz。


### 为什么归一化要除以 Δf
如果不除以 Δf：
* 当你把 nfft 改大，比如从 512 → 2048，频率格子变窄，但每个格子里能量变小，所以峰值会“看起来”变矮。
* 除以 Δf 就是把“每个格子的能量”转成“每 Hz 的能量”（功率谱密度），这样无论格子宽窄，幅度都可比。

### 类比
想象有一根蜡烛的蜡液量是固定的：
* 如果把蜡液分成 5 个大盒子，每个盒子看起来很多。
* 如果分成 50 个小盒子，每个盒子就显得少。
* 除以 Δf 就等于把“每个盒子里的蜡”换算成“每单位体积的浓度”，这样不管盒子大小，浓度一致。


**意义**：功率谱密度 = 功率谱 / Δf  
- 如果不除以 Δf，得到的是“每个 bin 的总功率”；
- 除以 Δf，则得到“每 Hz 的功率密度”，可消除 FFT 长度影响。

---

## 3. 窗能量归一化

### 为什么要归一化
不同窗函数对信号的加权不同，会改变 FFT 后的幅值。如果要让不同窗下的幅值可比，需要做能量归一化。

### 公式
归一化因子：  
$$
normFactor = sqrt(sum(win.^2))
$$
- **win**：窗函数向量（如 hann, hamming, boxcar 等）。
- $sum(win.^2)$：窗函数能量（平方和）。
- `sqrt(...)`：变回幅度尺度（因为能量是幅度平方）。

归一化方式：  
$$
X_norm = X / normFactor
$$
这样处理后，不同窗函数下同一正弦波的幅值保持一致。


### 不同窗函数的影响
<img width="300" height="150" alt="image" src="https://github.com/user-attachments/assets/5bd11e5d-3dd0-496c-9a86-d0bc62b3ce2b" />
<img width="300" height="150" alt="image" src="https://github.com/user-attachments/assets/c82fbd93-9e88-4f99-96c3-6e72e1b58cd4" />

#### 频谱泄漏 (Spectral Leakage)
- **原因**：截断的有限长信号在频域会变成主瓣 + 旁瓣的结构，非整数周期的成分会“泄漏”到其它频率。  
- **表现**：谱峰变宽、出现旁瓣，能量溢出到邻近频率。  
- **窗函数作用**：通过加权减弱截断处的突变，降低旁瓣高度，但主瓣会变宽。

#### 主瓣宽度 vs 旁瓣高度
- **矩形窗 (boxcar)**：主瓣最窄，旁瓣高（泄漏严重）。
- **Hann / Hamming**：主瓣略宽，旁瓣显著降低。
- **Blackman**：旁瓣更低，但主瓣更宽。
<img width="900" height="400" alt="image" src="https://github.com/user-attachments/assets/79f231e1-5e3f-4d41-8407-3a6bdbaeff40" />
<img width="672" height="468" alt="image" src="https://github.com/user-attachments/assets/580115f2-6042-4e72-86aa-916bf5e6b447" />

**平衡点**：选择窗时，要根据应用权衡频率分辨率（主瓣宽度）和泄漏抑制（旁瓣高度）。

---

## 4. 如果只关心相对幅值

如果只是想看形状或相对强弱，不关心绝对幅值：  
```matlab
STFT_IMGdB = 20*log10(S ./ max(S(:)));
```
这样直接归一化到最大值 0 dB，就不必做“单位带宽归一化”和“窗能量归一化”。

**注意**：
- 这种方法结果不能直接和其他 FFT 参数、窗函数不同的实验比较。
- 窗函数仍会影响谱形状（旁瓣抑制、峰值位置）。
